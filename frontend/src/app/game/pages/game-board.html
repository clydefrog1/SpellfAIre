<!-- Game Board Layout -->
<div
  class="game-board"
  [class.targeting]="targetMode() !== 'none'"
>

  <!-- Enemy Hero (top of screen) -->
  <div class="top-hero-bar">
    <div class="enemy-hero-stack">
      <app-hero-portrait
        [health]="opponentState()?.heroHealth ?? 0"
        [maxHealth]="25"
        side="opponent"
        [highlighted]="selectedTargetId() === 'ENEMY_HERO'"
        [disabled]="disableEnemyHeroAttackTarget()"
        [attentionToken]="disableEnemyHeroAttackTarget() ? enemyHeroGuardHintToken() : null"
        [attackTargetToken]="opponentUserId() ? getAttackTargetToken(opponentUserId()!) : null"
        [hitFx]="opponentUserId() ? getHitFx(opponentUserId()!) : null"
        [floatFx]="opponentUserId() ? getFloatFx(opponentUserId()!) : null"
        [spellFx]="opponentUserId() ? getSpellFx(opponentUserId()!) : null"
        [currentMana]="opponentState()?.currentMana ?? 0"
        [maxMana]="opponentState()?.maxMana ?? 0"
        [deckCount]="opponentState()?.deck?.length ?? 0"
        (heroClick)="onEnemyHeroClick()"
        (disabledClick)="onEnemyHeroDisabledClick()"
      />

      @if (enemyHeroGuardMessage()) {
        <div class="enemy-hero-guard-message" role="status">
          {{ enemyHeroGuardMessage() }}
        </div>
      }
    </div>
  </div>

  <!-- Opponent Battlefield -->
  <section class="board-row battlefield opponent-field">
    @for (entry of renderedOpponentBattlefield(); track entry.creature.instanceId) {
      <app-battlefield-creature
        @creatureSummon
        [creature]="entry.creature"
        [card]="getCard(entry.creature.cardId)"
        side="opponent"
        [selectable]="!entry.isDying && !isInteractionLocked() && targetMode() !== 'none'"
        [highlighted]="selectedTargetId() === entry.creature.instanceId"
        [attackSourceToken]="getAttackSourceToken(entry.creature.instanceId)"
        [attackTargetToken]="getAttackTargetToken(entry.creature.instanceId)"
        [hitFx]="getHitFx(entry.creature.instanceId)"
        [floatFx]="getFloatFx(entry.creature.instanceId)"
        [spellFx]="getSpellFx(entry.creature.instanceId)"
        [deathFx]="getDeathFx(entry.creature.instanceId)"
        [dying]="entry.isDying"
        (creatureClick)="onEnemyCreatureClick(entry.creature, entry.isDying)"
      />
    }
    @if (renderedOpponentBattlefield().length === 0) {
      <div class="empty-field">No creatures</div>
    }
  </section>

  <!-- Center Divider (consolidated action bar) -->
  <div class="board-divider">

    <!-- Center cluster: [Attack] [Turn Info] [End Turn] -->
    <div class="divider-middle">
      <div class="divider-action-left">
        @if (targetMode() !== 'none') {
          <button class="sf-button cancel-btn divider-btn" type="button" (click)="cancelSelection()">‚úï Cancel</button>
        }
        @if (targetMode() === 'spell' && selectedHandCardId()) {
          <button
            class="sf-button attack-btn divider-btn"
            type="button"
            (click)="executeSpellCast()"
            [disabled]="isInteractionLocked() || !selectedTargetId()"
          >‚ú® Cast Spell</button>
        }
        @if (targetMode() === 'attack' && selectedAttackerId()) {
          <button
            class="sf-button attack-btn divider-btn"
            type="button"
            (click)="executeAttack()"
            [disabled]="isInteractionLocked() || !readyToAttack()"
          >‚öîÔ∏è Attack</button>
        }
      </div>

      <!-- Turn info / targeting message -->
      <div class="turn-info">
        @if (targetMode() === 'spell') {
          <div class="targeting-message">
            <span class="target-icon">‚ú®</span>
            <div class="target-text">
              @if (selectedTargetId()) {
                <strong>Target Selected!</strong>
                <small>Click Cast Spell to execute, or Cancel</small>
              } @else {
                <strong>Spell Targeting</strong>
                @if (spellDisallowsFriendlyTargets()) {
                  <small>Click an enemy creature or hero to select a target</small>
                } @else {
                  <small>Click a creature or hero to select a target</small>
                }
              }
            </div>
          </div>
        } @else if (targetMode() === 'attack') {
          <div class="targeting-message">
            <span class="target-icon">‚öîÔ∏è</span>
            <div class="target-text">
              @if (selectedTargetId()) {
                <strong>Target Selected!</strong>
                <small>Click Attack to execute, or Cancel</small>
              } @else {
                <strong>Choose Target</strong>
                <small>Click an enemy creature or hero</small>
              }
            </div>
          </div>
        } @else {
          <div class="turn-status">
            <span class="turn-indicator" [@turnPulse]="isMyTurn() ? 'active' : 'waiting'">
              @if (isMyTurn()) { Your Turn } @else { Opponent's Turn }
            </span>
            <span class="turn-meta">
              Turn {{ game()?.turnNumber }}
              @if (isMyTurn() && !isInteractionLocked()) {
                &nbsp;&bull;&nbsp;<strong>Play cards</strong> or <strong>Attack</strong>
              }
            </span>
          </div>
        }
      </div>

      <div class="divider-action-right">
        <button
          class="sf-button action-btn end-turn-btn divider-btn"
          type="button"
          [disabled]="!isMyTurn() || isInteractionLocked()"
          (click)="endTurn()"
        >End Turn</button>
      </div>
    </div>

    <!-- Far right: surrender -->
    <div class="divider-far-right">
      <button
        class="sf-button surrender-btn divider-btn"
        type="button"
        [disabled]="isInteractionLocked()"
        (click)="surrender()"
      >Surrender</button>
    </div>
  </div>

  @if (showTutorialHint() && isMyTurn() && !isInteractionLocked() && renderedMyBattlefield().length > 0) {
    <div class="tutorial-hint">
      <div class="hint-content">
        <button class="hint-close" type="button" (click)="dismissHint()">‚úï</button>
        <h4>üí° How to Attack</h4>
        <ol>
          <li>Click your creature with a üó°Ô∏è sword icon</li>
          <li>Click an enemy creature or the enemy hero</li>
          <li>Click the ‚öîÔ∏è Attack button in the divider bar</li>
        </ol>
      </div>
    </div>
  }

  <!-- Player Battlefield -->
  <section class="board-row battlefield player-field">
    @for (entry of renderedMyBattlefield(); track entry.creature.instanceId) {
      <app-battlefield-creature
        @creatureSummon
        [creature]="entry.creature"
        [card]="getCard(entry.creature.cardId)"
        side="player"
        [selected]="selectedAttackerId() === entry.creature.instanceId"
        [highlighted]="targetMode() === 'spell' && selectedTargetId() === entry.creature.instanceId"
        [selectable]="isMyTurn() && !isInteractionLocked() && !entry.isDying && entry.creature.canAttack && !entry.creature.hasAttackedThisTurn"
        [attackSourceToken]="getAttackSourceToken(entry.creature.instanceId)"
        [attackTargetToken]="getAttackTargetToken(entry.creature.instanceId)"
        [hitFx]="getHitFx(entry.creature.instanceId)"
        [floatFx]="getFloatFx(entry.creature.instanceId)"
        [spellFx]="getSpellFx(entry.creature.instanceId)"
        [deathFx]="getDeathFx(entry.creature.instanceId)"
        [dying]="entry.isDying"
        (creatureClick)="onMyCreatureClick(entry.creature, entry.isDying)"
      />
    }
    @if (renderedMyBattlefield().length === 0) {
      <div class="empty-field">No creatures</div>
    }
  </section>

  <!-- Player Hand: [Creatures | Hero card center stub | Spells] -->
  <section class="board-row hand-row">
    <!-- Creatures group (left) -->
    <div class="hand-group hand-group-creatures">
      @if (handCreatures().length > 0) {
        <span class="hand-group-label">Creatures</span>
        <div class="hand-group-cards">
          @for (card of handCreatures(); track card.id) {
            <app-game-card
              @cardEnter
              [card]="card"
              [playable]="canPlayCard(card)"
              [insufficientMana]="isInsufficientMana(card)"
              [selected]="selectedHandCardId() === card.id"
              (cardClick)="onHandCardClick(card)"
            />
          }
        </div>
      } @else {
        <span class="hand-group-empty">No creatures</span>
      }
    </div>

    <!-- Center: Player hero card in hand zone -->
    <div class="hand-hero-anchor">
      <!-- Player hero -->
      <app-hero-portrait
        [health]="myState()?.heroHealth ?? 0"
        [maxHealth]="25"
        side="player"
        [highlighted]="targetMode() === 'spell' && !spellDisallowsFriendlyTargets()"
        [attackTargetToken]="myUserId() ? getAttackTargetToken(myUserId()!) : null"
        [hitFx]="myUserId() ? getHitFx(myUserId()!) : null"
        [floatFx]="myUserId() ? getFloatFx(myUserId()!) : null"
        [spellFx]="myUserId() ? getSpellFx(myUserId()!) : null"
        [currentMana]="myState()?.currentMana ?? 0"
        [maxMana]="myState()?.maxMana ?? 0"
        [deckCount]="myState()?.deck?.length ?? 0"
        (heroClick)="onMyHeroClick()"
      />
    </div>

    <!-- Spells group (right) -->
    <div class="hand-group hand-group-spells">
      @if (handSpells().length > 0) {
        <span class="hand-group-label">Spells</span>
        <div class="hand-group-cards">
          @for (card of handSpells(); track card.id) {
            <app-game-card
              @cardEnter
              [card]="card"
              [playable]="canPlayCard(card)"
              [insufficientMana]="isInsufficientMana(card)"
              [selected]="selectedHandCardId() === card.id"
              (cardClick)="onHandCardClick(card)"
            />
          }
        </div>
      } @else {
        <span class="hand-group-empty">No spells</span>
      }
    </div>
  </section>

  <!-- Event Bar (under hand row) -->
  <div class="event-bar">
    <app-game-event-log [events]="events()" />
  </div>

  <!-- Event Log -->
  <!-- Game Over Overlay -->
  @if (isGameOver()) {
    <app-game-over-overlay
      [won]="didWin()"
      (exit)="exitGame()"
      (playAgain)="exitGame()"
    />
  }
</div>
